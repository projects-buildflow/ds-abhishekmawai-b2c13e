name: Validate PR

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black pytest

      - name: Extract task info from branch
        id: task_info
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"

          # Flexible task ID extraction - matches multiple patterns:
          # - task-1.2, task-1.2-description
          # - feature/1.2-something
          # - 1.2-fix-bug
          TASK_ID=$(echo "$BRANCH" | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "")

          if [[ -n "$TASK_ID" ]]; then
            echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "Task ID: $TASK_ID"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "Branch name doesn't contain a task number (X.Y)"
          fi

      - name: Validate branch naming
        if: steps.task_info.outputs.valid != 'true'
        run: |
          echo "::error::Branch name must contain a task number (e.g., 1.2)"
          echo "Valid examples: task-1.2, task-1.2-fix-bug, feature/1.2, 1.2-my-work"
          exit 1

      - name: Run linting
        id: lint
        continue-on-error: true
        run: |
          # Run ruff and black on Python files
          ruff check . --output-format=github || echo "lint_failed=true" >> $GITHUB_OUTPUT
          black --check . || echo "lint_failed=true" >> $GITHUB_OUTPUT

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          TASK_ID="${{ steps.task_info.outputs.task_id }}"

          # Run task-specific tests if they exist
          TEST_FILE="tests/test_${TASK_ID//./_}.py"
          if [ -f "$TEST_FILE" ]; then
            echo "Running tests from $TEST_FILE"
            pytest "$TEST_FILE" -v --tb=short || echo "tests_failed=true" >> $GITHUB_OUTPUT
          else
            echo "No test file found at $TEST_FILE, skipping tests"
          fi

      - name: Check results
        run: |
          LINT_FAILED="${{ steps.lint.outputs.lint_failed }}"
          TESTS_FAILED="${{ steps.tests.outputs.tests_failed }}"

          if [ "$LINT_FAILED" = "true" ]; then
            echo "::error::Linting failed. Run 'ruff check . --fix' and 'black .' to fix."
          fi

          if [ "$TESTS_FAILED" = "true" ]; then
            echo "::error::Tests failed. Check the test output above."
          fi

          if [ "$LINT_FAILED" = "true" ] || [ "$TESTS_FAILED" = "true" ]; then
            exit 1
          fi

          echo "All checks passed!"

      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **All checks passed!**\n\nYour code looks good. A reviewer will merge this PR shortly.'
            })

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Checks failed**\n\nPlease review the errors above and push fixes. Common issues:\n- Linting: Run `ruff check . --fix` and `black .`\n- Tests: Check the test output for details'
            })
